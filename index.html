<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CharterHouseCars Admin Dashboard</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
      :root {
        --primary: #1a1f36;
        --accent: #ff6b35;
        --accent-light: #ff8c5a;
        --text: #2d3748;
        --light: #f8f9fa;
        --shadow: 0 6px 20px rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
      }
      * { margin:0; padding:0; box-sizing:border-box; font-family:Poppins,sans-serif; }
      body { background:var(--light); color:var(--text); line-height:1.5; }
      header {
        background:var(--primary); color:white; padding:1rem 1.5rem;
        display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
      }
      header h1 { font-size:1.4rem; display:flex; align-items:center; gap:8px; }
      header button {
        background:var(--accent); color:white; border:none; padding:8px 14px;
        border-radius:6px; cursor:pointer; font-size:0.95rem;
      }
      header button:hover { background:var(--accent-light); }
      main { max-width:1200px; margin:1.5rem auto; padding:0 15px; }
      .search-container { margin-bottom:1rem; text-align:right; }
      .search-container input {
        padding:9px 14px; width:260px; max-width:100%; border:1px solid #ccc;
        border-radius:6px; font-size:0.95rem;
      }
      table {
        width:100%; border-collapse:collapse; background:white;
        box-shadow:var(--shadow); border-radius:8px; overflow:hidden;
      }
      th, td { padding:11px 13px; text-align:left; border-bottom:1px solid #eee; }
      th { background:var(--primary); color:white; font-weight:600; }
      tr:hover { background:rgba(255,107,53,0.07); }
      .actions { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
      .btn-action {
        border:none; padding:8px 12px; border-radius:5px; cursor:pointer;
        color:white; font-size:0.9rem; min-width:42px; min-height:42px;
        display:inline-flex; align-items:center; justify-content:center;
      }
      .edit-btn    { background:#0069d9; } .edit-btn:hover    { background:#0056b3; }
      .delete-btn  { background:#dc3545; } .delete-btn:hover  { background:#c82333; }
      .whatsapp-btn{ background:#25d366; } .whatsapp-btn:hover{ background:#20b358; }
      .email-btn   { background:#db4437; } .email-btn:hover   { background:#c1351f; }
      .sms-btn     { background:#4CAF50; } .sms-btn:hover     { background:#388E3C; }

      #login-container {
        position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10000;
        display:flex; justify-content:center; align-items:center;
      }
      #login-form {
        background:white; padding:2rem; border-radius:10px; width:90%; max-width:380px;
        box-shadow:0 10px 25px rgba(0,0,0,0.2);
      }
      #login-form h2 { text-align:center; margin-bottom:1.2rem; color:var(--primary); }
      #login-form input {
        width:100%; padding:12px; margin-bottom:1rem; border:1px solid #ccc;
        border-radius:6px; font-size:1rem;
      }
      #login-form button {
        width:100%; padding:12px; background:var(--primary); color:white;
        border:none; border-radius:6px; cursor:pointer; font-size:1.05rem;
      }

      .edit-modal {
        position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:2000;
        display:none; justify-content:center; align-items:center;
      }
      .edit-modal.active { display:flex; }
      .edit-content {
        background:white; padding:1.8rem; border-radius:10px; width:90%; max-width:500px;
        max-height:90vh; overflow-y:auto; box-shadow:var(--shadow); position:relative;
      }
      .edit-close { position:absolute; top:10px; right:15px; font-size:2.2rem; cursor:pointer; color:#555; }
      .edit-content label { display:block; margin:10px 0 4px; font-weight:600; color:#444; }
      .edit-content input, .edit-content textarea {
        width:100%; padding:9px 12px; border:1px solid #ccc; border-radius:5px;
      }
      .edit-content textarea { min-height:80px; resize:vertical; }
      .edit-content button {
        margin-top:1.4rem; width:100%; padding:12px; background:var(--accent);
        color:white; border:none; border-radius:6px; cursor:pointer; font-size:1.05rem;
      }

      @media (max-width:768px) {
        table, thead, tbody, th, td, tr { display:block; }
        thead tr { position:absolute; top:-9999px; left:-9999px; }
        tr { margin-bottom:1.2rem; border:1px solid #ddd; border-radius:8px; }
        td { border:none; position:relative; padding-left:48%; min-height:44px; display:flex; align-items:center; }
        td::before {
          position:absolute; left:12px; width:45%; font-weight:600;
          content:attr(data-label); color:var(--primary);
        }
        .actions { padding:10px; justify-content:center; border-top:1px solid #eee; }
      }
    </style>
  </head>
  <body>

    <div id="login-container">
      <form id="login-form">
        <h2><i class="fas fa-user-shield"></i> Admin Login</h2>
        <input type="password" id="adminPassword" placeholder="Enter password" required autocomplete="off" />
        <button type="submit">Login</button>
      </form>
    </div>

    <header>
      <h1><i class="fas fa-car-side"></i> CharterHouseCars Admin</h1>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </header>

    <main>
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search bookings..." />
      </div>

      <table id="bookingTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Pickup</th>
            <th>Drop-off</th>
            <th>Date</th>
            <th>Time</th>
            <th>Vehicle</th>
            <th>Requests</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </main>

    <div class="edit-modal" id="editModal">
      <div class="edit-content">
        <span class="edit-close" id="editClose">×</span>
        <h3>Edit Booking</h3>
        <label>Name</label><input type="text" id="editName" />
        <label>Email</label><input type="email" id="editEmail" />
        <label>Phone</label><input type="tel" id="editPhone" />
        <label>Pickup Location</label><input type="text" id="editPickup" />
        <label>Drop-off Location</label><input type="text" id="editDropoff" />
        <label>Date</label><input type="date" id="editDate" />
        <label>Time</label><input type="time" id="editTime" />
        <label>Vehicle</label><input type="text" id="editVehicle" />
        <label>Special Requests</label><textarea id="editRequests"></textarea>
        <button id="saveEditBtn">Save Changes</button>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhEqtkjqt-_KCRCMmweX4RfySyVZ3OK2E",
        authDomain: "charterhousecars-5631d.firebaseapp.com",
        databaseURL: "https://charterhousecars-5631d-default-rtdb.firebaseio.com",
        projectId: "charterhousecars-5631d",
        storageBucket: "charterhousecars-5631d.appspot.com",
        messagingSenderId: "227890687089",
        appId: "1:227890687089:web:d656b58e6720a42ec2ffd0",
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      const PASSWORD = "Woking1@";

      const loginContainer = document.getElementById("login-container");
      const loginForm = document.getElementById("login-form");
      const logoutBtn = document.getElementById("logoutBtn");

      function isLoggedIn() {
        return sessionStorage.getItem("adminLoggedIn") === "true";
      }

      loginForm.addEventListener("submit", e => {
        e.preventDefault();
        if (document.getElementById("adminPassword").value.trim() === PASSWORD) {
          sessionStorage.setItem("adminLoggedIn", "true");
          loginContainer.style.display = "none";
          loadBookings();
        } else {
          alert("Wrong password");
        }
      });

      logoutBtn.addEventListener("click", () => {
        sessionStorage.removeItem("adminLoggedIn");
        location.reload();
      });

      if (isLoggedIn()) {
        loginContainer.style.display = "none";
        loadBookings();
      }

      const tableBody = document.querySelector("#bookingTable tbody");

      function loadBookings() {
        database.ref("bookings").on("value", snapshot => {
          tableBody.innerHTML = "";
          const bookings = snapshot.val() || {};

          if (Object.keys(bookings).length === 0) {
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:2rem;">No bookings yet</td></tr>';
            return;
          }

          Object.entries(bookings).forEach(([key, b]) => {
            const fullName = [b.firstName, b.lastName].filter(Boolean).join(" ") || "—";
            const row = document.createElement("tr");
            row.innerHTML = `
              <td data-label="Name">${fullName}</td>
              <td data-label="Email">${b.email || "—"}</td>
              <td data-label="Phone">${b.phone || "—"}</td>
              <td data-label="Pickup">${b.pickupLocation || "—"}</td>
              <td data-label="Drop-off">${b.dropoffLocation || "—"}</td>
              <td data-label="Date">${b.pickupDate || "—"}</td>
              <td data-label="Time">${b.pickupTime || "—"}</td>
              <td data-label="Vehicle">${b.vehicle || "—"}</td>
              <td data-label="Requests">${b.specialRequests || "—"}</td>
              <td data-label="Actions">
                <div class="actions">
                  <button class="btn-action edit-btn"    data-key="${key}" title="Edit booking"><i class="fas fa-edit"></i></button>
                  <button class="btn-action delete-btn"  data-key="${key}" title="Delete"><i class="fas fa-trash-alt"></i></button>
                  <button class="btn-action whatsapp-btn" data-key="${key}" title="Send via WhatsApp"><i class="fab fa-whatsapp"></i></button>
                  <button class="btn-action email-btn"   data-email="${b.email || ''}" data-name="${fullName}" title="Send via Email"><i class="fas fa-envelope"></i></button>
                  <button class="btn-action sms-btn"     data-phone="${b.phone || ''}" data-name="${fullName}" title="Send via SMS (UK)"><i class="fas fa-sms"></i></button>
                </div>
              </td>`;
            tableBody.appendChild(row);
          });
        });
      }

      tableBody.addEventListener("click", e => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const key   = btn.dataset.key;
        const email = btn.dataset.email;
        const phone = btn.dataset.phone;
        const name  = btn.dataset.name;

        if (btn.classList.contains("edit-btn"))    openEditModal(key);
        if (btn.classList.contains("delete-btn") && confirm("Delete booking?")) {
          database.ref("bookings/" + key).remove();
        }
        if (btn.classList.contains("whatsapp-btn")) {
          database.ref("bookings/" + key).once("value", s => {
            const b = s.val();
            if (b?.phone) sendWhatsApp(b);
            else alert("No phone number");
          });
        }
        if (btn.classList.contains("email-btn")) {
          if (email) sendEmail(email, name);
          else alert("No email address");
        }
        if (btn.classList.contains("sms-btn")) {
          if (phone) sendSMS(phone, name);
          else alert("No phone number for SMS");
        }
      });

      document.getElementById("searchInput").addEventListener("input", e => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll("#bookingTable tbody tr").forEach(r => {
          r.style.display = r.textContent.toLowerCase().includes(term) ? "" : "none";
        });
      });

      const editModal = document.getElementById("editModal");
      const editClose = document.getElementById("editClose");
      const saveEditBtn = document.getElementById("saveEditBtn");
      let currentEditKey = "";

      function openEditModal(key) {
        currentEditKey = key;
        database.ref("bookings/" + key).once("value", s => {
          const b = s.val() || {};
          document.getElementById("editName").value = [b.firstName, b.lastName].filter(Boolean).join(" ");
          document.getElementById("editEmail").value = b.email || "";
          document.getElementById("editPhone").value = b.phone || "";
          document.getElementById("editPickup").value = b.pickupLocation || "";
          document.getElementById("editDropoff").value = b.dropoffLocation || "";
          document.getElementById("editDate").value = b.pickupDate || "";
          document.getElementById("editTime").value = b.pickupTime || "";
          document.getElementById("editVehicle").value = b.vehicle || "";
          document.getElementById("editRequests").value = b.specialRequests || "";
          editModal.classList.add("active");
        });
      }

      editClose.addEventListener("click", () => editModal.classList.remove("active"));

      saveEditBtn.addEventListener("click", () => {
        const nameParts = document.getElementById("editName").value.trim().split(/\s+/);
        const firstName = nameParts[0] || "";
        const lastName = nameParts.slice(1).join(" ") || "";

        database.ref("bookings/" + currentEditKey).update({
          firstName, lastName,
          email: document.getElementById("editEmail").value.trim(),
          phone: document.getElementById("editPhone").value.trim(),
          pickupLocation: document.getElementById("editPickup").value.trim(),
          dropoffLocation: document.getElementById("editDropoff").value.trim(),
          pickupDate: document.getElementById("editDate").value,
          pickupTime: document.getElementById("editTime").value,
          vehicle: document.getElementById("editVehicle").value.trim(),
          specialRequests: document.getElementById("editRequests").value.trim()
        }).then(() => {
          editModal.classList.remove("active");
        }).catch(err => alert("Save failed: " + err.message));
      });

      function sendWhatsApp(b) {
        const name = b.firstName || "Customer";
        const msg = `Hello ${name},\n\nYour CharterHouseCars booking for ${b.vehicle || 'a vehicle'} on ${b.pickupDate || '—'} at ${b.pickupTime || '—'} is confirmed.\n\nThank you!\nCharterHouseCars Team`;
        const phone = (b.phone || "").replace(/\D/g, "");
        if (!phone) return alert("No valid phone");
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, "_blank");
      }

      function sendEmail(email, name = "Customer", booking = {}) {
  const subject = "CharterHouseCars Booking Confirmation";

  const body = `
Dear ${name},

Your booking is now confirmed ✓

We look forward to serving you ✓

Booking details reminder:
• Vehicle:        ${booking.vehicle        || '—'}
• Pickup:         ${booking.pickupLocation  || '—'}
• Drop-off:       ${booking.dropoffLocation || '—'}
• Date:           ${booking.pickupDate      || '—'}
• Time:           ${booking.pickupTime      || '—'}

If you have any questions or need assistance,
please reply to this email ✓

Thank you for choosing CharterHouseCars!

Best regards,  
CharterHouseCars Team
`.trim();

  const mailto = `mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.open(mailto, "_blank");
}

      function sendSMS(phone, name = "Customer") {
        const cleanPhone = phone.replace(/\D/g, ''); // Remove non-digits
        if (!cleanPhone || cleanPhone.length < 9) { // Basic UK validation (e.g., 07xxx...)
          alert("Invalid or missing UK phone number for SMS");
          return;
        }

        // Simple UK-focused confirmation message
        const message = `Dear ${name}, your CharterHouseCars booking is confirmed. Thank you for choosing us! Reply if needed.`;

        // sms: URI opens default SMS app (Messages on Android, etc.)
        // For UK, phone should be in international format: +447xxxxxxxxx
        let smsUri = `sms:${cleanPhone.startsWith('44') ? '+' + cleanPhone : '+44' + cleanPhone}?body=${encodeURIComponent(message)}`;

        window.open(smsUri, "_blank");
      }
    </script>
  </body>
</html>