<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CharterHouseCars Admin Dashboard</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
      :root {
        --primary: #1a1f36;
        --accent: #ff6b35;
        --accent-light: #ff8c5a;
        --text: #2d3748;
        --light: #f8f9fa;
        --shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
      }
      * { margin:0; padding:0; box-sizing:border-box; font-family:Poppins,sans-serif; }
      body { background:var(--light); color:var(--text); }
      header {
        background:var(--primary); color:white; padding:1rem 2rem;
        display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
      }
      header h1 { font-size:1.5rem; display:flex; align-items:center; gap:10px; }
      header button {
        background:var(--accent); color:white; border:none; padding:8px 16px;
        border-radius:6px; cursor:pointer; transition:var(--transition);
      }
      header button:hover { background:var(--accent-light); }
      main { max-width:1200px; margin:2rem auto; padding:0 16px; }
      input, button { outline:none; }
      table {
        width:100%; border-collapse:collapse; box-shadow:var(--shadow);
        background:white; border-radius:10px; overflow:hidden;
      }
      th, td { padding:12px 14px; text-align:left; border-bottom:1px solid #ddd; }
      th { background:var(--primary); color:white; }
      tr:hover { background:rgba(255,107,53,0.08); }
      .actions { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
      .edit-btn, .delete-btn, .whatsapp-btn, .email-btn {
        border:none; padding:10px 14px; border-radius:6px; cursor:pointer;
        color:white; font-size:1rem; min-width:48px; min-height:48px;
        display:inline-flex; align-items:center; justify-content:center;
        transition:var(--transition);
      }
      .edit-btn    { background:#007bff; } .edit-btn:hover    { background:#0056b3; }
      .delete-btn  { background:var(--accent); } .delete-btn:hover  { background:#e55325; }
      .whatsapp-btn{ background:#25d366; } .whatsapp-btn:hover{ background:#1da851; }
      .email-btn   { background:#ea4335; } .email-btn:hover   { background:#c5221f; }

      #login-container {
        position:fixed; inset:0; background:rgba(0,0,0,0.75);
        display:flex; justify-content:center; align-items:center; z-index:9999;
      }
      #login-form {
        background:white; padding:2rem; border-radius:12px;
        width:90%; max-width:400px; box-shadow:var(--shadow);
      }
      #login-form h2 { text-align:center; margin-bottom:1.5rem; color:var(--primary); }
      #login-form input {
        width:100%; padding:12px; margin-bottom:1rem;
        border:1px solid #ccc; border-radius:6px; font-size:1rem;
      }
      #login-form button {
        width:100%; padding:12px; background:var(--primary); color:white;
        border:none; border-radius:6px; font-size:1.1rem; cursor:pointer;
      }
      #login-form button:hover { background:var(--accent); }

      .search-container { margin:1.5rem 0; text-align:right; }
      .search-container input {
        padding:10px 14px; width:280px; max-width:100%;
        border:1px solid #ccc; border-radius:6px;
      }

      .edit-modal {
        position:fixed; inset:0; background:rgba(0,0,0,0.7);
        display:none; justify-content:center; align-items:center; z-index:2000;
      }
      .edit-modal.active { display:flex; }
      .edit-content {
        background:white; padding:1.8rem; border-radius:10px;
        width:90%; max-width:480px; max-height:90vh; overflow-y:auto;
        position:relative; box-shadow:var(--shadow);
      }
      .edit-close { position:absolute; top:10px; right:15px; font-size:2rem; cursor:pointer; }
      .edit-content label { display:block; margin:12px 0 4px; font-weight:600; }
      .edit-content input, .edit-content textarea {
        width:100%; padding:10px; border:1px solid #ccc; border-radius:5px;
      }
      .edit-content textarea { min-height:80px; }
      .edit-content button {
        margin-top:1.5rem; width:100%; padding:12px;
        background:var(--accent); color:white; border:none; border-radius:6px;
        cursor:pointer;
      }

      @media (max-width:768px) {
        table, thead, tbody, th, td, tr { display:block; }
        thead tr { position:absolute; top:-9999px; left:-9999px; }
        tr { margin-bottom:1.2rem; border:1px solid #ddd; border-radius:8px; }
        td { border:none; position:relative; padding-left:50%; min-height:48px; display:flex; align-items:center; }
        td::before {
          position:absolute; left:12px; width:45%; font-weight:bold;
          content:attr(data-label); color:var(--primary);
        }
        .actions { padding:12px; justify-content:center; }
      }
    </style>
  </head>
  <body>

    <div id="login-container">
      <form id="login-form">
        <h2><i class="fas fa-user-shield"></i> Admin Login</h2>
        <input type="password" id="adminPassword" placeholder="Enter password" required autocomplete="off" />
        <button type="submit">Login</button>
      </form>
    </div>

    <header>
      <h1><i class="fas fa-car-side"></i> CharterHouseCars Admin</h1>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </header>

    <main>
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search bookings..." />
      </div>

      <table id="bookingTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Pickup</th>
            <th>Drop-off</th>
            <th>Date</th>
            <th>Time</th>
            <th>Vehicle</th>
            <th>Requests</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </main>

    <div class="edit-modal" id="editModal">
      <div class="edit-content">
        <span class="edit-close" id="editClose">×</span>
        <h3>Edit Booking</h3>
        <label>Name</label><input type="text" id="editName" />
        <label>Email</label><input type="email" id="editEmail" />
        <label>Phone</label><input type="tel" id="editPhone" />
        <label>Pickup Location</label><input type="text" id="editPickup" />
        <label>Drop-off Location</label><input type="text" id="editDropoff" />
        <label>Date</label><input type="date" id="editDate" />
        <label>Time</label><input type="time" id="editTime" />
        <label>Vehicle</label><input type="text" id="editVehicle" />
        <label>Special Requests</label><textarea id="editRequests"></textarea>
        <button id="saveEditBtn">Save Changes</button>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhEqtkjqt-_KCRCMmweX4RfySyVZ3OK2E",
        authDomain: "charterhousecars-5631d.firebaseapp.com",
        databaseURL: "https://charterhousecars-5631d-default-rtdb.firebaseio.com",
        projectId: "charterhousecars-5631d",
        storageBucket: "charterhousecars-5631d.appspot.com",
        messagingSenderId: "227890687089",
        appId: "1:227890687089:web:d656b58e6720a42ec2ffd0",
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      const PASSWORD = "Woking1@";

      // Login handling with sessionStorage (clears on refresh)
      const loginContainer = document.getElementById("login-container");
      const loginForm = document.getElementById("login-form");
      const logoutBtn = document.getElementById("logoutBtn");

      function isLoggedIn() {
        return sessionStorage.getItem("adminLoggedIn") === "true";
      }

      loginForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const pass = document.getElementById("adminPassword").value.trim();
        if (pass === PASSWORD) {
          sessionStorage.setItem("adminLoggedIn", "true");
          loginContainer.style.display = "none";
          loadBookings();
        } else {
          alert("Incorrect password");
        }
      });

      logoutBtn.addEventListener("click", () => {
        sessionStorage.removeItem("adminLoggedIn");
        location.reload();
      });

      if (isLoggedIn()) {
        loginContainer.style.display = "none";
        loadBookings();
      }

      const tableBody = document.querySelector("#bookingTable tbody");

      function loadBookings() {
        database.ref("bookings").on("value", (snapshot) => {
          tableBody.innerHTML = "";
          const bookings = snapshot.val() || {};

          if (Object.keys(bookings).length === 0) {
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:2rem;">No bookings found</td></tr>';
            return;
          }

          Object.entries(bookings).forEach(([key, b]) => {
            const fullName = `${b.firstName || ""} ${b.lastName || ""}`.trim() || "—";
            const row = document.createElement("tr");
            row.innerHTML = `
              <td data-label="Name">${fullName}</td>
              <td data-label="Email">${b.email || "—"}</td>
              <td data-label="Phone">${b.phone || "—"}</td>
              <td data-label="Pickup">${b.pickupLocation || "—"}</td>
              <td data-label="Drop-off">${b.dropoffLocation || "—"}</td>
              <td data-label="Date">${b.pickupDate || "—"}</td>
              <td data-label="Time">${b.pickupTime || "—"}</td>
              <td data-label="Vehicle">${b.vehicle || "—"}</td>
              <td data-label="Requests">${b.specialRequests || "—"}</td>
              <td data-label="Actions">
                <div class="actions">
                  <button class="edit-btn" data-key="${key}"><i class="fas fa-edit"></i></button>
                  <button class="delete-btn" data-key="${key}"><i class="fas fa-trash-alt"></i></button>
                  <button class="whatsapp-btn" data-key="${key}"><i class="fab fa-whatsapp"></i></button>
                  <button class="email-btn" data-email="${b.email || ''}" data-name="${fullName}"><i class="fas fa-envelope"></i></button>
                </div>
              </td>`;
            tableBody.appendChild(row);
          });
        });
      }

      // Event delegation for buttons
      tableBody.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const key = btn.dataset.key;
        const email = btn.dataset.email;
        const name = btn.dataset.name;

        if (btn.classList.contains("edit-btn")) {
          openEditModal(key);
        } else if (btn.classList.contains("delete-btn")) {
          if (confirm("Delete this booking?")) {
            database.ref("bookings/" + key).remove();
          }
        } else if (btn.classList.contains("whatsapp-btn")) {
          database.ref("bookings/" + key).once("value", snap => {
            const b = snap.val();
            if (b?.phone) {
              sendWhatsApp(b);
            } else {
              alert("No phone number found for this booking.");
            }
          });
        } else if (btn.classList.contains("email-btn")) {
          if (email) {
            sendEmail(email, name);
          } else {
            alert("No email address found for this booking.");
          }
        }
      });

      // Search
      document.getElementById("searchInput").addEventListener("input", (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll("#bookingTable tbody tr").forEach(row => {
          row.style.display = row.textContent.toLowerCase().includes(term) ? "" : "none";
        });
      });

      // Edit modal
      const editModal = document.getElementById("editModal");
      const editClose = document.getElementById("editClose");
      const saveEditBtn = document.getElementById("saveEditBtn");
      let currentEditKey = "";

      function openEditModal(key) {
        currentEditKey = key;
        database.ref("bookings/" + key).once("value", snap => {
          const b = snap.val() || {};
          document.getElementById("editName").value = `${b.firstName || ""} ${b.lastName || ""}`.trim();
          document.getElementById("editEmail").value = b.email || "";
          document.getElementById("editPhone").value = b.phone || "";
          document.getElementById("editPickup").value = b.pickupLocation || "";
          document.getElementById("editDropoff").value = b.dropoffLocation || "";
          document.getElementById("editDate").value = b.pickupDate || "";
          document.getElementById("editTime").value = b.pickupTime || "";
          document.getElementById("editVehicle").value = b.vehicle || "";
          document.getElementById("editRequests").value = b.specialRequests || "";
          editModal.classList.add("active");
        });
      }

      editClose.addEventListener("click", () => editModal.classList.remove("active"));

      saveEditBtn.addEventListener("click", () => {
        const [firstName, ...lastNameParts] = document.getElementById("editName").value.trim().split(/\s+/);
        const lastName = lastNameParts.join(" ");
        database.ref("bookings/" + currentEditKey).update({
          firstName: firstName || "",
          lastName: lastName || "",
          email: document.getElementById("editEmail").value.trim(),
          phone: document.getElementById("editPhone").value.trim(),
          pickupLocation: document.getElementById("editPickup").value.trim(),
          dropoffLocation: document.getElementById("editDropoff").value.trim(),
          pickupDate: document.getElementById("editDate").value,
          pickupTime: document.getElementById("editTime").value,
          vehicle: document.getElementById("editVehicle").value.trim(),
          specialRequests: document.getElementById("editRequests").value.trim()
        }).then(() => {
          editModal.classList.remove("active");
        }).catch(err => alert("Could not save: " + err.message));
      });

      // WhatsApp - opens chat with prefilled message
      function sendWhatsApp(b) {
        const name = b.firstName || "Customer";
        const message = `Hello ${name},\n\nYour booking for ${b.vehicle || "a vehicle"} on ${b.pickupDate || "—"} at ${b.pickupTime || "—"} is confirmed.\n\nThank you for choosing CharterHouseCars!`;
        const phone = (b.phone || "").replace(/\D/g, "");
        if (!phone) {
          alert("No valid phone number.");
          return;
        }
        const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
        window.open(url, "_blank");
      }

      // Email - opens compose screen with prefilled To, subject, body
      function sendEmail(email, name) {
        const subject = "Your CharterHouseCars Booking Confirmation";
        const body = `Dear ${name},

Your booking has been confirmed.

Details:
Vehicle: [will be visible in your email app]
Date: [will be visible in your email app]
Time: [will be visible in your email app]

We look forward to serving you!

Best regards,
CharterHouseCars Team`;

        
      }
    </script>
  </body>
</html>